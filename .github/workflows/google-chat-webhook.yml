name: Google Chat Webhook

on:
  workflow_call:
    inputs:
      header_image:
        description: "Custom header image URL (optional)"
        default: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
        required: false
        type: string
      reply_option:
        description: "new_thread or same_thread (optional, default same_thread)"
        default: 'same_thread'
        required: false
        type: string
    secrets:
      google_chat_webhook:
        required: true

  pull_request:
    types: [opened, synchronize, reopened, closed]

  pull_request_review:
    types: [submitted]

jobs:
  notify-google-chat:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare inputs
        id: prepare_inputs
        run: |
          echo "HEADER_IMAGE=" >> $GITHUB_ENV
          if [ "${{ inputs.reply_option }}" == "new_thread" ]; then
            echo "REPLY_OPTION=MESSAGE_REPLY_OPTION_UNSPECIFIED" >> $GITHUB_ENV
          else
            echo "REPLY_OPTION=REPLY_MESSAGE_FALLBACK_TO_NEW_THREAD" >> $GITHUB_ENV
          fi

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            case "${{ github.event.action }}" in
              opened)
                echo "HEADER_IMAGE=${{ inputs.header_image }}" >> $GITHUB_ENV
                echo 'PR_EVENT=üìå Pull Request Created' >> $GITHUB_ENV
                ;;
              synchronize)
                echo 'PR_EVENT=üîÑ Pull Request Updated' >> $GITHUB_ENV
                ;;
              reopened)
                echo 'PR_EVENT=üîì Pull Request Reopened' >> $GITHUB_ENV
                ;;
              closed)
                if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
                  echo 'PR_EVENT=üéâ Pull Request Merged' >> $GITHUB_ENV
                else
                  echo 'PR_EVENT=‚ùå Pull Request Closed' >> $GITHUB_ENV
                fi
                ;;
              *)
                echo 'PR_EVENT=üìå Pull Request Event' >> $GITHUB_ENV
                ;;
            esac
          fi

      - name: Prepare Event Message
        id: prepare_event_message
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "opened" ]]; then
            MESSAGE+="üîó <b>Repository:</b> ${{ github.repository }}<br/>"
            MESSAGE+="üìÑ <b>Title:</b> ${{ github.event.pull_request.title }}<br/>"
            MESSAGE+="üë§ <b>Author:</b> @${{ github.actor }}"
          elif [[ "${{ github.event_name }}" == "pull_request_review" ]]; then
            MESSAGE+="üë§ <b>Reviewer:</b> @${{ github.actor }}"
          else
            MESSAGE+="üë§ <b>User:</b> @${{ github.actor }}"
          fi
          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send Notification to Google Chat
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{
                "cardsV2": [{
                  "cardId": "pr-notification",
                  "card": {
                    "header": {
                      "title": "'"$PR_EVENT"'",
                      "subtitle": " ",
                      "imageUrl": "'"$HEADER_IMAGE"'"
                    },
                    "sections": [{
                      "widgets": [{
                        "textParagraph": {
                          "text": "'"$MESSAGE"'"
                        }
                      }]
                    },
                    {
                      "widgets": [{
                        "buttonList": {
                          "buttons": [{
                            "text": "üîç View Pull Request",
                            "onClick": {
                              "openLink": {
                                "url": "'"${{ github.event.pull_request.html_url }}"'"
                              }
                            }
                          }]
                        }
                      }]
                    }]
                  }
                }],
                "thread": {
                  "threadKey": "'"${{ github.repository }}/${{ github.event.pull_request.number }}"'"
                }
              }' \
          "${{ secrets.google_chat_webhook }}&messageReplyOption=$REPLY_OPTION"
